#!/bin/bash -e

project_path=.
f=0
for opt in "${@}"; do
  if [[ ${f} == 1 ]]; then
    project_path=$opt
    break
  fi
  case "${opt}" in
    "-projectPath") f=1 ;;
  esac
done

unity_install_dir=
unity_bin_path=
if [ "$(uname)" == 'Darwin' ]; then
  unity_install_dir="/Applications/Unity/Hub/Editor"
  unity_bin_path="Unity.app/Contents/MacOS/Unity"
elif [ "$(expr substr $(uname -s) 1 10)" == 'MINGW32_NT' -o "$(expr substr $(uname -s) 1 10)" == 'MINGW64_NT' ]; then
  unity_install_dir="/c/Program Files/Unity/Hub/Editor"
  unity_bin_path="Editor/Unity.exe"
else
  echo "Your platform ($(uname -a)) is not supported." 1>&2
  exit 1
fi

if [ -n "${UNITY_INSTALL_DIR}" ]; then
  unity_install_dir=${UNITY_INSTALL_DIR}
fi

version_file="${project_path%/}/ProjectSettings/ProjectVersion.txt"
unity_version=
if [ -e "${version_file}" ]; then
  unity_version=$(yq r "${version_file}" m_EditorVersion)
else
  unity_version=$(ls "${unity_install_dir}" | sort -n -t "." -k 1 -k 2 -k 3 -k 4 | tail -n 1)
fi

unity="${unity_install_dir%/}/${unity_version}/${unity_bin_path}"

"${unity}" ${@}
